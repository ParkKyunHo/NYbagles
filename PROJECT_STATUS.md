# 베이글샵 통합 관리 시스템 - 프로젝트 현황

## 📅 최종 업데이트: 2025년 7월 31일 (9차) - RLS 정책 수정 및 코드 정리

## 🎯 프로젝트 개요
뉴욕러브베이글 매장의 통합 관리를 위한 웹 기반 시스템입니다. QR 코드 기반 출퇴근 관리, 매출 관리, 직원 관리 등의 기능을 제공합니다.

## 🚀 배포 현황
- **프로덕션 사이트**: Vercel에 배포 완료
- **GitHub 리포지토리**: https://github.com/ParkKyunHo/NYbagles.git
- **자동 배포**: main 브랜치 푸시 시 자동 배포

## ✅ 구현 완료된 기능

### 1. 인증 시스템
- **Supabase Auth 기반 로그인/로그아웃**
  - 이메일/비밀번호 인증
  - 세션 관리
  - 자동 로그아웃
- **역할 기반 접근 제어 (RBAC)**
  - super_admin: 전체 시스템 관리
  - admin: 지역 매장 관리
  - manager: 단일 매장 관리
  - employee/part_time: 일반 직원

### 2. QR 코드 시스템
- **매장별 고유 QR 코드**
  - 30초마다 자동 갱신 (TOTP 기반)
  - AES-256 암호화
  - HMAC-SHA256 서명 검증
- **QR 스캐너 페이지** (`/dashboard/attendance/scan`)
  - 카메라 권한 요청
  - 실시간 QR 코드 스캔
  - 스캔 결과 검증
  - **GPS 위치 트래킹 통합** ✅
- **출퇴근 기록 자동화** ✅
  - QR 스캔 → 출퇴근 기록 생성
  - 근무 시간 자동 계산
  - 주간/월간 통계 표시

### 3. 데이터베이스 구조
- **계층적 조직 구조**
  - regions (지역)
  - store_categories (매장 카테고리)
  - stores (매장)
  - employees (직원)
- **QR 토큰 관리**
  - qr_tokens 테이블
  - 토큰 생성 및 검증 함수
- **출퇴근 기록**
  - attendance_records 테이블
  - QR 검증 필드

### 4. 구현된 페이지
- **인증 관련**
  - `/login` - 로그인 페이지 ✅
  - `/signup` - 회원가입 선택 페이지 ✅
  - `/signup/employee` - 직원 회원가입 페이지 ✅
- **대시보드**
  - `/dashboard` - 메인 대시보드 ✅ (7/27 출퇴근 통계 개선)
  - `/dashboard/attendance` - 출퇴근 메인 페이지 ✅
  - `/dashboard/attendance/scan` - QR 스캔 페이지 ✅ (7/27 GPS 통합)
  - `/dashboard/work-hours` - 근무 시간 조회 ✅ (7/27 구현)
- **스케줄 관리** (7/27 구현)
  - `/schedule` - 스케줄 메인 페이지 ✅
  - `/schedule/create` - 스케줄 등록 페이지 ✅
- **상품 관리** (7/27 구현)
  - `/products` - 상품 카탈로그 관리 ✅
  - `/products/create` - 상품 등록 페이지 ✅
  - `/products/store` - 매장별 상품 관리 ✅
- **관리자**
  - `/admin` - 관리자 대시보드 ✅ (7/27 전면 개편)
  - `/admin/signup-requests` - 직원 가입 승인 페이지 ✅ (7/27 구현)

### 5. 인프라 및 보안
- **보안 미들웨어**
  - Rate Limiting (IP당 요청 제한)
  - CORS 설정
  - 보안 헤더 (XSS, CSRF 방지)
- **에러 처리**
  - 중앙집중식 에러 핸들링
  - 도메인별 에러 클래스
  - 사용자 친화적 에러 메시지
- **로깅 시스템**
  - 구조화된 로그
  - 개발/프로덕션 환경별 설정

### 6. 초기 데이터
- **지역**: 서울, 경기, 부산
- **매장 카테고리**: 강남구, 종로구, 마포구
- **샘플 매장**:
  - NY베이글 강남역점
  - NY베이글 삼성점
- **관리자 계정**: admin@nylovebagel.com

### 6. 판매 관리 시스템 ✅ (7/27 구현)
- **백엔드 구현**
  - sales_records 테이블 확장 (결제 방법, 취소 기능)
  - sales_items 테이블 (다중 상품 판매 지원)
  - daily_sales_summary 테이블 (일일 매출 자동 집계)
  - API 엔드포인트 (생성, 조회, 취소, 통계)
- **프론트엔드 구현**
  - `/dashboard/sales` - 판매 입력 페이지 ✅
  - `/dashboard/sales/history` - 판매 내역 조회 ✅
  - `/dashboard/sales/summary` - 매출 요약 대시보드 ✅
  - 실시간 재고 확인 및 장바구니 기능
  - 역할별 권한 관리 (취소는 매니저 이상)

### 7. 직원 관리 시스템 ✅ (7/27 구현)
- **직원 목록 페이지**
  - `/dashboard/employees` - 전체 직원 목록 ✅
  - 검색 및 필터링 (이름, 매장, 직급)
  - 직원 상태 관리 (활성/비활성)
  - 통계 표시 (전체, 활성, 매니저, 파트타임)
- **직원 상세 페이지**
  - `/dashboard/employees/[id]` - 개별 직원 정보 ✅
  - 정보 수정 기능 (관리자만)
  - 최근 30일 근무 기록
  - 향후 14일 스케줄 표시
- **권한 관리**
  - 매니저는 자기 매장 직원만 조회
  - 관리자는 전체 직원 관리 가능

## ❌ 미구현 기능

### 아직 구현되지 않은 주요 기능들

1. **고급 스케줄 기능**
   - 스케줄 변경 요청 시스템
   - 스케줄 템플릿 관리
   - 스케줄 충돌 감지

2. **알림 시스템**
   - 실시간 알림 (Supabase Realtime)
   - 이메일 알림 (Edge Functions)
   - 푸시 알림 (PWA)

3. **리포트 생성**
   - PDF 리포트 생성
   - 정기 리포트 스케줄링
   - 커스텀 리포트 빌더

4. **백업 및 복구**
   - 자동 백업 시스템
   - 데이터 내보내기/가져오기
   - 복구 프로세스

5. **모바일 앱**
   - PWA 최적화
   - 오프라인 모드
   - 네이티브 앱 개발

### 11. 직원 회원가입 개선 ✅ (7/28 구현)
- **매장 선택 기능**
  - 매장 코드 입력 대신 드롭다운 선택
  - 활성 매장만 표시
  - 가입 요청 시 매장 정보 포함

### 12. 관리자 기능 개선 ✅ (7/28 구현)
- **가입 승인 페이지**
  - 직원 소속 매장 변경 기능
  - 매장 변경 모달 UI
  - 실시간 매장 정보 업데이트

### 13. 급여 관리 시스템 ✅ (7/29 구현)
- **간소화된 급여 계산**
  - `/dashboard/salary` - 급여 관리 페이지 ✅
  - 직원별 시급 설정 기능
  - 출퇴근 기록 기반 자동 시간 계산
  - 시급 × 근무시간 계산
  - 월별 급여 조회 및 관리
  - 출퇴근 시간 자동 계산 트리거

### 14. 데이터베이스 개선 ✅ (7/29 구현)
- **데이터 무결성**
  - employees.store_id NOT NULL 제약 조건 추가
  - 문서 스토리지 지원 테이블 및 함수 추가
  - 문서 만료 알림 시스템
  - 문서 업로드 로그 추적

### 15. 문서 관리 시스템 ✅ (7/29 구현)
- **문서 스토리지 인프라**
  - Supabase Storage 통합
  - 문서 카테고리 관리 (신분증, 계약서, 건강진단서 등)
  - 문서 만료일 추적 및 알림
  - 업로드 이력 관리
  - `/dashboard/documents` - 문서 관리 페이지 (구현 예정)

### 16. UI/UX 개선 ✅ (7/30 구현)
- **WCAG 접근성 준수**
  - 판매 입력 대시보드 폰트 대비 개선 
  - 직원 관리 필터 폰트 대비 개선
- **매장 선택 UI 개선**
  - 시/도, 구/군 레이블 추가
  - 전국 지역 데이터 추가 (17개 시/도, 229개 구/군/시)

### 17. 직원 가입 요청 시스템 개선 ✅ (7/30 구현)
- **직원 회원가입 폼 수정**
  - 불필요한 패스워드 필드 제거 (승인 시 관리자가 설정)
  - 매장 선택 시 지역 정보 표시 (시/도 - 구/군)
  - RLS 정책 추가로 비로그인 사용자도 매장 정보 조회 가능
- **가입 요청 관리 페이지 신규 추가**
  - `/dashboard/employee-requests` - 직원 가입 요청 관리
  - 상태별 필터링 (대기중/인증완료/승인됨/거절됨)
  - 승인/거절 기능 구현
  - 사이드바에 "가입 요청" 메뉴 추가

### 18. 기타 개선사항 ✅ (7/30 구현)
- **QR 출퇴근 대시보드**
  - 404 에러 수정 (라우팅 경로 수정)
  - `/dashboard/attendance` → `/attendance` 경로 통일
- **상품 관리 개선**
  - 카테고리 관리 모달 추가
  - SKU 검색을 상품명 검색으로 변경
  - SKU 필드 제거
  - 판매 입력 대시보드 결제 방법 버튼 대비 개선
  - 직원 관리 대시보드 필터 섹션 대비 개선
- **매장 관리 UI 개선**
  - 지역/카테고리 레이블을 시/도, 구/군으로 명확하게 변경

### 17. 전국 지역 데이터 추가 ✅ (7/30 구현)
- **17개 시/도 데이터 추가**
  - 서울, 인천, 경기, 대전, 세종, 충북, 충남
  - 광주, 전북, 전남, 부산, 대구, 울산
  - 경북, 경남, 강원, 제주
- **229개 구/군/시 데이터**
  - 서울 25개 구 전체
  - 전국 모든 시/군/구 데이터 포함
- **데이터 추가 스크립트**
  - `scripts/addSeoulDistricts.ts` - 서울 지역 추가
  - `scripts/addNationwideLocations.ts` - 전국 지역 추가

### 18. 직원 회원가입 개선 ✅ (7/30 구현)
- **매장 선택 UI 개선**
  - 매장 표시 형식: "매장명 - 구/군" (예: "NY베이글 강남역점 - 강남구")
  - 지역별 그룹화된 드롭다운 (optgroup 사용)
  - 매장의 전체 위치 정보 표시 (시/도, 구/군)
- **데이터 로딩 개선**
  - store_categories와 regions 테이블 조인
  - 로딩 상태 표시
  - 에러 처리 추가

### 19. RLS 정책 수정 및 코드 정리 ✅ (7/31 9차 업데이트)
- **RLS 정책 전면 재구성**
  - products, product_categories, store_products 테이블의 모든 중복 정책 제거
  - 'authenticated' 역할로 통일된 정책 재생성
  - store_products 자동 생성 트리거 추가
  - 정책 권한 명확화 (읽기: 모든 인증 사용자, 쓰기: 권한별 제한)
- **코드 정리 작업**
  - 중복 컴포넌트 제거 (EmployeeSignupFormFixed.tsx)
  - 프로덕션 코드에서 console.log 12개 제거
  - 오래된 마이그레이션 스크립트 5개 아카이브 (/scripts/archive/)
  - package.json의 사용하지 않는 스크립트 제거 (fix:db, validate:fixes, fix:all)
- **코드 품질 개선**
  - 타입 체크 통과 확인
  - 빌드 에러 없음 확인
  - 깨진 import 없음 확인

## ⚠️ 진행중인 이슈 (7/31 기준)

1. **상품 로딩 오류**
   - 증상: "상품을 불러오는 중 오류가 발생했습니다" 메시지 지속
   - 시도한 해결: RLS 정책 전면 재구성
   - 상태: 미해결

2. **시스템 관리자 매장 선택 제한**
   - 증상: 판매 관리 대시보드에서 관리자가 "강남본점"으로 고정됨
   - 예상 동작: 시스템 관리자는 모든 매장을 선택할 수 있어야 함
   - 상태: 미해결

3. **회원가입 시 비밀번호 입력란 누락**
   - 증상: 직원 회원가입 시 비밀번호 입력 필드가 없음
   - 예상 동작: 회원가입 시 비밀번호를 직접 설정할 수 있어야 함
   - 상태: 미해결

## 🚀 다음 개발 우선순위

### Phase 1: 시스템 안정화 ✅ (완료)
- ~~데이터베이스 정리 (store_id NULL 값 처리)~~
- ~~문서 스토리지 지원 추가~~
- ~~급여 계산 시스템 구현 (시급 × 시간)~~
- ~~프로덕션 배포~~

### Phase 2: 고급 기능 (진행중)
1. **알림 시스템**
   - 실시간 알림 (Supabase Realtime)
   - 이메일 알림 (Edge Functions)
   - 푸시 알림 (PWA)

2. **백업 및 복구**
   - 자동 백업 시스템
   - 데이터 내보내기/가져오기
   - 복구 프로세스

3. **문서 관리 UI**
   - 문서 업로드 페이지
   - 문서 조회 및 다운로드
   - 만료 알림 대시보드

### Phase 3: 확장 기능
1. **리포트 및 대시보드**
   - 경영진 대시보드
   - 매출 리포트 자동 생성
   - KPI 모니터링

2. **모바일 최적화**
   - PWA 기능 강화
   - 오프라인 모드 개선
   - 푸시 알림 통합

## 📁 프로젝트 문서
- **README.md** - 프로젝트 소개 및 시작 가이드
- **CLAUDE.md** - Claude AI 작업 가이드
- **UPDATE_GUIDE.md** - 코드 수정 및 업데이트 가이드 ✨
- **VERCEL_DEPLOYMENT_GUIDE.md** - Vercel 배포 가이드 ✨
- **PROJECT_STATUS.md** - 프로젝트 현황 (이 문서)
- **NEXT_TASKS.md** - 다음 작업 목록
- **ADMIN_SETUP_GUIDE.md** - 관리자 계정 설정 방법
- **TEST_RESULTS.md** - 테스트 결과 및 체크리스트

## 🛠 기술 스택
- **Frontend**: Next.js 14, TypeScript, Tailwind CSS
- **Backend**: Supabase (PostgreSQL, Auth, Storage)
- **Security**: TOTP, AES-256, HMAC-SHA256
- **PWA**: Service Worker, 오프라인 지원

## 📝 참고사항
- 모든 404 오류 페이지는 향후 개발 예정
- PWA 기능으로 인해 오프라인 페이지가 표시될 수 있음 (시크릿 모드 사용 권장)
- 관리자 계정은 Supabase Dashboard에서 수동 생성 필요